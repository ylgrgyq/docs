{% import "views/_helper.njk" as docs %}
# 云引擎运行方案

这篇文档主要介绍云引擎的付费方案、如何管理云引擎的资源、如何使用组管理功能。

## 体验实例

我们对于每个应用都默认赠送一个「基本资源 0.5 CPU + 256 MB 内存」的体验实例，可以免费使用，供开发者学习和测试云引擎。

体验实例在进行部署等管理操作时会暂停服务；同时体验实例会执行 [休眠策略](#休眠策略)，没有请求时会休眠，有请求时启动（首次启动可能需要几秒的时间），每天最多运行 18 个小时。

## 标准实例

对于商业项目和正式上线的产品，开发者可根据需要，付费购买更多不同规格的标准实例。标准实例 24 小时运行随时待命，无请求时也不会休眠，并配有预备环境方便测试。如果购买了两个或更多的实例，还能实现负载均衡、平滑部署等高级功能，充分保障服务的可用性。

<dl>
<dt>预备环境</dt>
<dd>
<p>系统为预备环境提供了一个体验实例。这样在正式上线前，你可以先将代码发布到预备环境，使用线上的环境和数据进行模拟测试。</p>
</dd>
<dt>多实例实现服务高可用性</dt>
<dd>
<p>添加两个或更多的实例不但可以提高处理能力，还可以实现<u>负载均衡</u>和<u>故障容灾</u>。这是因为系统会自动将多个实例分配到不同的物理服务器上，当一个实例崩溃重启，或当其所在服务器出现意外的硬件故障时，系统会自动进行故障转移（failover），将请求自动交由其他实例处理，从而保障了服务的高可用性。</p>

{% call docs.noteWrap() %}
【单实例】相比之下，使用单个实例无法实现负载均衡或故障容灾。因为当一个单实例所在的服务器发生了宕机，该实例会在几分钟之内被迁移到正常的服务器上，在此期间该实例无法对任何应用请求做出响应。因此，{{ docs.alertInline("我们建议对服务可用性要求较高的应用，应该使用两个以上的云引擎实例。") }}
{% endcall %}
</dd>
<dt>平滑部署</dt>
<dd>
<p>在代码部署时，系统会优先启动使用新版本代码的实例，待新实例通过了健康检查，系统修改路由将请求转发至新实例后，再关闭旧版本的实例，让服务保持零中断。</p>
</dd>
<dt>创建分组，绑定不同域名或部署多份代码</dt>
<dd>
<p>将实例分组可以实现在访问同一数据源的情况下，部署多份云引擎代码，满足不同的业务需求。每个组可以设置独立的二级域名。详见 [组管理](#组管理)。</p>
</dd>
</dl>

如果不想继续付费，请删除在当前应用下所有生产环境中的标准实例。如此以来，系统会自动切换回体验实例，并停止扣费。

## 休眠策略

<div class="callout callout-info">标准实例不会休眠。</div>

体验实例会 **启用休眠策略**。

* 如果应用最近一段时间（半小时）没有任何外部请求，则休眠。
* 休眠后如果有新的外部请求实例则马上启动。访问者的体验是第一个请求响应时间是 2 ~ 10 秒（视实例启动时间而定），后续访问响应速度恢复正常。
* <a id="强制休眠" name="强制休眠"></a>强制休眠：如果最近 24 小时内累计运行超过 18 小时，则强制休眠。此时新的请求会收到 503 的错误响应码，该错误可在 {% if node=='qcloud' %} `云引擎 > 统计 > Status 页面` {% else %} [云引擎 > 统计 > Status 页面](/cloud.html?appid={{appid}}#/stat) {% endif %} 中查看。


**提示**：如果不希望预备环境的体验实例因为强制休眠而中断服务，或需要多个实例来完整模拟生产环境，可以在预备环境根据需要购买标准实例。

## 实例管理

一个包含 **0.5 CPU、256 MB 内存** 的实例被定义为「基本资源」，这一规格标明了该实例最大可以使用的硬件资源，即应用理论上最大 CPU 使用量为 50%，最大内存使用量 256 MB。

开发者可以将基本资源组合使用：

* 启动 4 个基本资源的实例，即 4 个 0.5 CPU、256 MB 内存的实例。
* 启动 2 个 2 倍基本资源的实例，即 2 个 1 CPU、512 MB 内存的实例。

创建第一个标准实例需要应用所有者的余额大于 200 元，之后每创建一个实例需要额外 50 元余额，同时每个应用最多创建 12 个实例，如果需要更多资源请通过 <support@leancloud.rocks> 联系我们的技术支持。

### 创建和管理实例
点击实例管理界面下的 <span class="btn btn-primary">创建新实例</span>，选择所需要的资源规格，点击 **保存**。

<img class="responsive" src="images/leanengine_plan_pro_create_instance.png" width="600" height="325">
<p class="text-muted">图中可选实例的规格在未来可能会改变，请以控制台中的实际数字为准。</p>

你还可以点击标准实例右上角的小齿轮来进行 **调整实例规格** 或 **删除** 等操作，删除实例不会造成应用的数据丢失，但应用对并发访问的处理能力会降低。

### 选择实例规格

为了防止实例因为资源使用超限而受到影响（特别是内存超限），我们建议：

- 压力较大的稳定期，**CPU** 使用达到或超过阈值的 **30%** 就建议提高实例规格。
- 压力较大的稳定期，**内存** 使用达到或超过阈值的 **70％** 就建议提高实例规格。

要了解实例资源的耗用程度，请阅读 [实例资源的使用量](#实例资源的使用量)。

<div class="callout callout-info">
**充分利用高规格实例的资源**<br/>
对于 Node.js 应用，默认单进程最大使用 CPU 为 100%，内存为 1.5 GB。如果实例规格远远大于此使用量，就会出现实例资源无法被充分利用的情况。因此你需要使用 cluster 模块来 [多进程运行](leanengine_webhosting_guide-node.html#多进程运行)，确保资源充分利用。
</div>

### 选择实例数量

开发者可以使用多个实例，并以此来提升整个应用的业务处理容量，保证服务的高可用性，但并不是说实例的数量越多越好。比如使用 8 个以上的实例反而会使部署周期变长（因为要重启的实例数量增多），这样多实例的好处就不明显了。

因此，我们建议将实例的数量控制在 **2～4 个之间**。

- 如果应用的业务压力较小，出于故障转移的目的，我们建议使用 2 个 0.5 CPU、256 MB 内存的实例。
- 如果应用的业务压力很大，出于防止实例数过多的目的，我们建议使用 4～6 个 4 CPU、2 GB 内存的实例。

要了解实例所承担的业务压力的大小，请阅读 [实例资源的使用量](#实例资源的使用量)。

### 实例资源的使用量

{% if node=='qcloud' %}
`控制台 > 存储 > 云引擎 > 统计`页面显示出当前应用下所有实例资源的使用情况，开发者由此可以判断实例资源是否即将或已经超限。
{% else %}
[控制台 > 存储 > 云引擎 > 统计](/cloud.html?appid={{appid}}#/stat) 页面显示出当前应用下所有实例资源的使用情况，开发者由此可以判断实例资源是否即将或已经超限。
{% endif %}

- **CPU**<br/>
  曲线图展现出在一段时间内应用实际 CPU 的使用量。如果 CPU 接近或达到阈值，应用表现为请求响应时间延长。
- **内存**<br/>
  曲线图展现出在一段时间内应用内存的实际使用量。如果内存使用量达到阈值，则相关的业务进程（比如 Node.js 进程或者 Python 进程）会因为内存溢出（OOM）而重启，从而导致业务处理中断，并且该实例在启动期间服务不可用。如果内存曲线图<u>频繁地接近阈值然后忽然下降</u>，就说明内存使用超限导致了进程重启。
- **响应时间**<br/>
  若曲线图升高，说明 CPU 使用量达到或超过阈值，实例的 CPU 资源紧张。
- **概况**<span class="text-muted">（下拉列表）</span><br/>
  所有实例资源使用量的总和。
- **详细**<span class="text-muted">（下拉列表）</span><br/>
  单个实例的资源使用量。

后续我们会提供阈值告警服务，这样当 CPU 或内存的使用量达到开发者为应用所设置的阈值时，系统便会向开发者发送警告通知。要扩容实例资源请参考 [选择实例规格](#选择实例规格) 和 [选择实例数量](#选择实例数量)。

## 组管理

开发者还可以使用云引擎的组管理功能，建立多个独立的云引擎实例分组，在访问同一数据源的情况下，部署多套不同的服务器端业务代码，并对每个分组设置独立的二级域名，实现更丰富的业务需求：

* 将用户界面和管理后台拆分为不同的项目，使用不同的域名。
* 单独部署主系统之外的边缘支持系统，以免边缘系统出现问题时影响主系统。
* 使用不同的服务器端语言来编写云函数和网站，例如你可以使用 Node.js 编写云函数，而用 PHP 来实现网站。

云引擎默认会有一个用于处理云函数、Hook 和定时任务的分组，其他额外创建的分组将成为「拓展分组」，**拓展分组不支持通过 SDK 来调用云函数，也不支持 Hook 函数和定时任务，只能通过绑定的二级域名或自定义域名提供网站托管服务**。在创建了多个分组后，你可以随时在云引擎的设置界面切换默认分组。

每个分组都有独立的预备环境用于测试代码、独立的域名供外部访问，每个分组的环境变量、代码仓库等设置也是独立的，你可以单独对一个组部署代码。你可以按照 [实例管理](#实例管理) 一节中的介绍，在分组中创建和管理实例，如果组中没有实例就无法响应请求，如果组中有多个实例变可以提供负载均衡和高可用的能力。

关于组管理功能费用请参考 [组管理功能价格](#组管理功能价格) 。

### 创建和管理组

你可以在 [控制台 > 存储 > 云引擎](/cloud.html?appid={{appid}}) 中点击左上角的分组选择框，点击「分组管理」，即可创建新的分组、删除分组、修改默认分组。

在选择一个分组之后，便可以在设置界面中修改分组的代码仓库、二级域名、环境变量等信息。也可以在分组下创建新的实例，开发者只能创建生产环境实例，在创建第一个实例时会自动赠送一个预备环境；在删除最后一个实例时也会删除预备环境；在删除分组前需要先删除分组下的实例。

在使用命令行工具部署拥有多个组的应用时，请确保命令行工具版本至少为 `0.7.1`。可以使用 `$ lean version` 来查看当前版本。更多关于命令行工具的介绍，请参考 [命令行工具 CLI 使用指南](leanengine_cli.html)。

## 价格

云引擎的计费独立于 [开发版 / 商用版](/pricing/) 方案，开通或取消商用版不影响云引擎的实例和计费。

### 实例价格

体验实例不收取费用。

{% if node=='qcloud' %}
标准实例按天扣费，使用时间不足一天按一天收费，次日凌晨系统从账户余额中扣费。
{% else %}
标准实例按天扣费，使用时间不足一天按一天收费，次日凌晨系统从账户余额中扣费，费用明细可在 [交易历史](/bill.html#/bill/record) 中查看。
{% endif %}

{% if node=='qcloud' %}
不同容量的云引擎实例的价格，请参考 [官网报价](./price.html)。不同的节点使用不同的结算货币，价格会有差异，敬请留意。
{% else %}
不同容量的云引擎实例的价格，请参考 [官网报价](/pricing)。不同的节点使用不同的结算货币，价格会有差异，敬请留意。
{% endif %}

例如，假设每个基本资源 1 元／天（实际价格以官网报价为准），即：

* 如果启动 4 个基本资源的实例，即 4 ✕ 1 元 = 4 元／天。
* 如果启动 2 个 2 倍基本资源的实例，即 (2 ✕ 2) ✕ 1 元 = 4 元／天。

资源使用量按当天**最大**资源占用计算。假设某天从 0 点至 23:59 分之间：

* 创建了 4 个基本资源实例；
* 发现资源数量不足，将 4 个实例都扩容 2 倍，即占用 8 个基本资源容量；
* 发现资源过多，删除 1 个实例，当前占用 6 个基本资源。

则当天费用按照 8 个基本资源计算。

### 组管理功能价格

如果应用云引擎只有一个分组，则不收取组管理功能的费用。

如果应用云引擎分组大于一个，则认为开启组管理功能，价格为当前应用下所有基本资源的数量 ✕ 基本资源单价 ✕ 20%。

例如，假设每个基本资源 1 元／天（实际价格以官网报价为准），即：

- 如果启动 4 个基本资源的实例，即 4 ✕ 1 元 ✕ 20% = 0.8 元／天。
- 如果启动 2 个 2 倍基本资源的实例，即 (2 ✕ 2) ✕ 1 元 ✕ 20% = 0.8 元／天。

如果应用移除其他分组，只保留一个，则认为关闭组管理功能，从次日开始不收取组管理功能的费用。

**注意**：分组中没有实例也认为分组存在，所以如果确认不使用请将相关分组删除。
