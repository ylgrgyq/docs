<!--# åšä¸ªé¤åŽ…ç®¡ç†ç³»ç»Ÿæ²¡ç”¨ LeanStorageï¼Œè¿™ä½ç¨‹åºå‘˜è¢«è€æ¿å¼€é™¤äº†-->

# å­˜å‚¨æœåŠ¡æ¡ˆä¾‹åˆ†æž - é¤åŽ…ç®¡ç†ç³»ç»Ÿè®¾è®¡

## è¿™ç¯‡æ•™ç¨‹è®²ä»€ä¹ˆï¼Ÿ
- è¯¦è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªé¤åŽ…-åº§ä½-é¢„è®¢ç®¡ç†ç³»ç»Ÿåœ¨ LeanCloud å¦‚ä½•å¿«é€Ÿçš„å¼€å‘
- åœ¨æ²¡æœ‰ mongodb ç›¸å…³çŸ¥è¯†å‚¨å¤‡çš„æƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨ LeanCloud SDK æä¾›çš„æŽ¥å£ä½¿ç”¨ LeanCloud å­˜å‚¨æœåŠ¡
- åœ¨è¡¨è®¾è®¡çš„æ—¶å€™å¦‚ä½•åˆç†çš„ä½¿ç”¨ Relationï¼ŒPoninter å’Œè‡ªå»ºä¸­é—´è¡¨

## è¯»å®Œè¿™ç¯‡æ•™ç¨‹ä¹‹åŽèƒ½å­¦åˆ°ä»€ä¹ˆï¼Ÿ
å¦‚ä¸‹å†…å®¹å¯¹ä¸ªäººæƒ…å†µä¸åŒå¯èƒ½æœ‰æ‰€åå·®ï¼Œä½†æ˜¯å¤§è‡´å¦‚æ­¤ã€‚

å‡è®¾æ¯ä¸€é¡¹æŠ€èƒ½ä»¥ 10 æ˜Ÿè®¡ç®—ï¼Œ10 æ˜Ÿå¯ä»¥ç§°ä¸ºè¯¥æŠ€èƒ½çš„ä¸šç•Œé¡¶å°–æ°´å¹³

- mongodb ä½¿ç”¨æ°´å¹³æå‡ï¼š1 æ˜Ÿ
- é€»è¾‘å»ºæ¨¡èƒ½åŠ›æå‡ï¼š2 æ˜Ÿ
- ç¼–ç¨‹æ°´å¹³æå‡ï¼š2 æ˜Ÿ
- LeanCloud çŸ¥è¯†å‚¨å¤‡å¢žåŠ ï¼š4 æ˜Ÿ


## é¡¹ç›®èƒŒæ™¯ä»‹ç»
æœ¬æ–‡ç¼˜èµ·ä¸€ä¸ªç”¨æˆ·åœ¨ç¤¾åŒºçš„è®¨è®ºï¼š

æˆ‘æƒ³è®¾è®¡ä¸€ä¸ªè¡¨ç»“æž„ï¼Œèƒ½å®žçŽ°å¦‚ä¸‹éœ€æ±‚ï¼š

- å±•çŽ°é¤åŽ…åˆ—è¡¨
- æ¯ä¸ªé¤åŽ…éœ€è¦ç®¡ç†é¤åŽ…å†…éƒ¨çš„åº§ä½
- æ¯ä¸ªåº§ä½åœ¨æ¯å¤©çš„æŸä¸€ä¸ªæ—¶æ®µå¯èƒ½ä¼šè¢«é¢„å®šï¼Œæˆ‘éœ€è¦ç®¡ç†è¿™äº›é¢„å®š
- ç»™è€æ¿å±•çŽ°æ¯ä¸€ä¸ªé¤åŽ…æŸä¸€ä¸ªæ—¶æ®µçš„é¢„è®¢çŽ‡
- ç»™è€æ¿å±•çŽ°æŸä¸€ä¸ªé¤åŽ…çš„æŸä¸€ä¸ªåº§ä½çš„ç¿»æ¡ŒçŽ‡ï¼ˆè¿™ä¸ªä½ç½®å¯èƒ½é çª—æˆ·ä¹Ÿå¯èƒ½åº§ä½æœ¬èº«çš„è®¾è®¡å¾ˆå—æ¬¢è¿Žï¼‰


ä¸€å¼€å§‹æˆ‘ä»¬åªæ˜¯è®¨è®ºï¼ŒåŽæ¥æˆ‘ä»¬è·Ÿè¿™ä¸ªå®¢æˆ·ä¹Ÿå¤šæ¬¡æ²Ÿé€šæœ€åŽåœ¨ä¸æ–­çš„æŽ¢è®¨ä¸‹æˆ‘ä»¬å‘çŽ°å…¶ä¸­å¾ˆå¤šè®¾è®¡çš„æ€è·¯é’ˆå¯¹å…¶ä»–ç³»ç»Ÿæ˜¯é€‚ç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬ç‰¹åˆ«æç‚¼å‡ºä¸€äº›ç²¾åŽåˆ†äº«ç»™æ‰€æœ‰ LeanCloud å¼€å‘è€…ï¼Œå¸Œæœ›å‡å°‘å¤§å®¶ã€ŒæŽ‰å‘ã€æƒ…å†µçš„å‘ç”Ÿï¼Œé¦–å…ˆæˆ‘ä»¬æ¥é’ˆå¯¹ä¸Šè¿°éœ€æ±‚ä¸€ä¸ªä¸€ä¸ªæ‹†è§£ï¼Œé€æ­¥å®žçŽ°è¿™ä¸ªç³»ç»Ÿé‡Œé¢çš„è¡¨ç»“æž„è®¾è®¡ã€‚


## å±•çŽ°é¤åŽ…åˆ—è¡¨(Restaurant)

é¦–å…ˆæˆ‘ä»¬ç®€åŒ–é¤åŽ…çš„å­—æ®µï¼Œæˆ‘ä»¬å…ˆä¿å­˜ä¸€ä¸‹åŸºæœ¬å­—æ®µï¼ˆåŽæ–‡ä¼šæ ¹æ®éœ€æ±‚è¡¥å……æˆ–è€…ä¿®æ”¹å­—æ®µï¼‰ï¼š

id|name(é¤åŽ…åç§°:string)
--|--
r1|å’Œå¹³é¥­åº—
r2|åŒ—äº¬é¥­åº—
r3|å¸Œå°”é¡¿å¤§é…’åº—


ç„¶åŽè°ƒç”¨ SDK çš„ä»£ç åˆ›å»ºå®ƒä»¬:

```js
'use strict';
var AV = require('leancloud-storage');

exports.newRestaurant = function newRestaurant(restaurantData) {
    let name = restaurantData.name || '';
    if (name == '') {
        throw new Error('é¤åŽ…å¿…é¡»å¾—æœ‰ä¸ªåå­—å§ï¼ŒðŸ˜œ');
    }
    let id = restaurantData.id || '';
    let restaurant = new AV.Object('Restaurant');
    restaurant.set('name', name);
    restaurant.set('id', id);
    return restaurant.save();
}

// è°ƒç”¨ä»£ç å¦‚ä¸‹:
let restaurantData = {
    id:'r1'
    name: 'å’Œå¹³é¥­åº—',
};
newRestaurant(restaurantData).then(result => {
    console.log(result.id);
});
```

## åº§ä½(Seat)

id|under(å½’å±žé¤åŽ…:Pointer)|capacity(åº§ä½å®¹é‡:number)
--|--|--
s1|r1|2
s2|r1|3
s3|r1|4
s4|r2|2
s5|r2|2
s6|r3|5

```js
//filename:booking.js
'use strict';
var AV = require('leancloud-storage');

exports.newSeat = function newSeat(seatData) {
    let restaurant = seatData.restaurant;
    if (restaurant == undefined) throw new Error('ä¸€ä¸ªåº§ä½å¿…é¡»å±žäºŽä¸€ä¸ªé¤åŽ…å•Šï¼Œäº² ðŸš');
    let capacity = seatData.capacity || 1;
    let seat = new AV.Object('Seat');
    let id = seatData.id || '';
    seat.set('under', restaurant);
    seat.set('id', id);
    seat.set('capacity', capacity);

    return seat.save();
}

// è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š
let restaurantData = {
    id : 'r1',
    name: 'å’Œå¹³é¥­åº—',
};
newRestaurant(restaurantData).then(restaurant => {
    let seatData = {
        capacity: 5,
        restaurant: restaurant
    };
    return newSeat(seatData);
}).then(result => {
    // ä¿å­˜æˆåŠŸ
}).catch(error => {
    console.log(error);
});
```

## é¢„è®¢è¡¨(Bookings)

seat(åº§ä½:)|from(é¢„è®¢èµ·å§‹æ—¶é—´:Date)|to(é¢„è®¢ç»“æŸæ—¶é—´:Date)
--|--|--
s1|2017-02-01 18:00|2017-02-01 19:00
s1|2017-02-02 15:00|2017-02-02 16:00
s2|2017-02-02 15:00|2017-02-01 16:00
s2|2017-02-01 18:00|2017-02-01 19:00
s3|2017-02-01 18:00|2017-02-01 19:00
s3|2017-02-01 18:00|2017-02-01 19:00


```js
//filename:booking.js
'use strict';
var AV = require('leancloud-storage');

exports.newBooking = function newBooking(bookingtData) {
    let seat = bookingtData.seat;
    if(typeof seat === 'undefined') throw new Error('è®¢åº§ä½çš„æ—¶å€™ä¸€å®šè¦æŒ‡å®šåº§ä½...');
    let from = bookingtData.from;
    if(typeof from === 'undefined') throw new Error('è®¢åº§ä½çš„æ—¶å€™ä¸€å®šè¦æŒ‡å®šæŒ‡å®šé¢„è®¢èµ·å§‹æ—¶é—´'); 
    let to = bookingtData.to;
    if(typeof to === 'undefined') throw new Error('è®¢åº§ä½çš„æ—¶å€™ä¸€å®šè¦æŒ‡å®šæŒ‡å®šç»“æŸå°±é¤çš„æ—¶é—´');

    let booking = new AV.Object('Booking');
    booking.set('seat',seat);
    booking.set('from',from);
    booking.set('to',to);

    return booking.save();
}
```

## æŸ¥è¯¢æŸä¸€ä¸ªé¤åŽ…çš„æŸä¸€ä¸ªæ—¶æ®µçš„é¢„è®¢æƒ…å†µ

é¦–å…ˆæˆ‘ä»¬é’ˆå¯¹ä¸Šè¿°çš„éœ€æ±‚æ‹†è§£æŸ¥è¯¢æ¡ä»¶ï¼š

1. æŸ¥è¯¢æŸä¸€ä¸ªé¤åŽ…é‡Œé¢é‡Œé¢æ‰€æœ‰çš„åº§ä½
2. æŸ¥è¯¢ä¸€äº›åº§ä½åœ¨æŸä¸€ä¸ªæ—¶æ®µçš„é¢„è®¢æƒ…å†µ

æ‹†è§£ä¹‹åŽï¼Œæˆ‘ä»¬æ¥ç”¨ä»£ç é€æ­¥å®žçŽ°ã€‚

### æŸ¥è¯¢æŸä¸€ä¸ªé¤åŽ…é‡Œé¢é‡Œé¢æ‰€æœ‰çš„åº§ä½

å‡è®¾æ•°æ®åº“å­˜åœ¨å¦‚ä¸‹æ•°æ®ï¼š

objectId|id|name
--|--|--|--|--
5901d458da2f60005de8f51d|r1|å’Œå¹³é¥­åº—
5901d458a0bb9f0065e57f33|r2|åŒ—äº¬é¥­åº—
5901d45844d90400690d1109|r3|å¸Œå°”é¡¿å¤§é…’åº—

æŸ¥è¯¢å’Œå¹³é¥­åº—æ‹¥æœ‰çš„åº§ä½:

```js
exports.querySeats = function querySeats(restaurant) {
    if (typeof restaurant == 'string') {
        restaurant = AV.Object.createWithoutData('Restaurant', restaurant);
    } else if (typeof restaurant != 'AV.Object') {
        throw new Error('ä»…æ”¯æŒä¼ å…¥ string å’Œ AV.Object');
    }
    let query = new AV.Query('Seat');
    query.equalTo('under',restaurant);
    return query.find();
}
// å‡è®¾å’Œå¹³é¥­åº—çš„å­˜å‚¨ä¹‹åŽçš„ objectId  ä¸º 5901d458da2f60005de8f51d

let restaurant = '5901d458da2f60005de8f51d';
querySeats(restaurant).then(result => {
    // result ä¸ºå’Œå¹³é¥­åº—é‡Œé¢çš„åº§ä½
    console.log(result);
});
```

### æŸ¥è¯¢ä¸€äº›åº§ä½åœ¨æŸä¸€æ—¶æ®µçš„é¢„å®šæƒ…å†µ

```js
exports.queryBookingInBatch = function queryBookingInBatch(seats, from, to) {
    let seatObjArray = [];

    if (seats instanceof Array) {
        seats.forEach(seat => {
            if (typeof seat == 'string') {
                seatObjArray.push(AV.Object.createWithoutData('Seat', seat));
            } else if (seat instanceof AV.Object) {
                if (seat.className != 'Seat') throw new TypeError('seats ä¸å¯ä»¥åŒ…å«å…¶ä»– AV.Object ç±»åž‹');
                seatObjArray.push(seat);
            }
        });
    }
    
    let query = new AV.Query('Booking');
    // å…³é”®ä»£ç æŸ¥è¯¢åŒ…å«åœ¨æ•°ç»„ä¸­çš„ seat çš„é¢„å®šè®°å½•
    query.containedIn('seat', seatObjArray);
    query.greaterThanOrEqualTo('from', from);
    query.lessThanOrEqualTo('to', to);
    return query.find();
}
//è°ƒç”¨ä»£ç 
    let seats = ['5901d4590ce463006153ba5f','5901d4598d6d810058ba4eba'];
    // SDK é’ˆå¯¹ UTC æ—¶é—´åšäº†æ—¶åŒºè½¬åŒ–ï¼Œå› æ­¤æŸ¥è¯¢çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ä¼ å…¥ UTC æ—¶é—´
    let from = new Date("2017-04-25T02:00:00Z");
    let to = new Date("2017-04-25T14:00:00Z");
    queryBookingInBatch(seats, from, to).then(result => {
        console.log(result);
    }).catch(error => {
        console.error(error);
    });
```

### æŸ¥è¯¢æŸä¸€å®¶é¤åŽ…çš„æŸä¸€ä¸ªæ—¶æ®µçš„é¢„å®šæƒ…å†µ

ç»“åˆå‰é¢ä¸¤ä¸ªæŸ¥è¯¢æˆ‘ä»¬å¯ä»¥å®žçŽ°ä¸€ä¸ªåˆ†ä¸ºä¸¤æ­¥çš„æŸ¥è¯¢

- å…ˆæŸ¥è¯¢å‡ºé¤åŽ…çš„åº§ä½
- ç„¶åŽæŸ¥è¯¢è¿™äº›ä½œä¸ºçš„é¢„å®šæƒ…å†µ

```js
let restaurant = AV.Object.createWithoutData('Restaurant', '5901d458da2f60005de8f51d');
querySeats(restaurant).then(seats => {
    // SDK é’ˆå¯¹ UTC æ—¶é—´åšäº†æ—¶åŒºè½¬åŒ–ï¼Œå› æ­¤æŸ¥è¯¢çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ä¼ å…¥ UTC æ—¶é—´
    let from = new Date("2017-04-25T02:00:00Z");
    let to = new Date("2017-04-25T14:00:00Z");
    return queryBookingInBatch(seats, from, to);
}).then(result => {
    console.log(result);
    chai.assert.isTrue(result.length > 1);
    done();
}).catch(error => {
    console.error(error);
});
```

## å…¶ä»–æŸ¥è¯¢éœ€æ±‚

### æŸ¥è¯¢ä¸€ä¸ªåº§ä½åœ¨æŸä¸€ä¸ªæ—¶æ®µçš„é¢„è®¢æƒ…å†µ

æˆ‘ä»¬æŒ‘é€‰ä¸€ä¸ªåº§ä½: s1ï¼Œå®ƒéš¶å±žäºŽå’Œå¹³é¥­åº—(r1)ï¼ŒæŸ¥è¯¢ `Booking`è¡¨ï¼ŒèŽ·å–åœ¨ 2017-04-25 è¿™ä¸€å¤©ä¸Šåˆ 10 ç‚¹åˆ°æ™šä¸Š 22 ç‚¹ä¹‹é—´è¥ä¸šæ—¶é—´çš„é¢„å®šæƒ…å†µ:

```js
exports.queryBooking = function queryBooking(seat,from,to) {
    if (typeof seat == 'string') {
        seat = AV.Object.createWithoutData('Seat', seat);
    } else if (!(seat instanceof AV.Object)) {
        throw new TypeError('ä»…æ”¯æŒä¼ å…¥ string å’Œ AV.Object');
    }
    let query = new AV.Query('Booking');
    query.equalTo('seat',seat);
    query.greaterThanOrEqualTo('from',from);
    query.lessThanOrEqualTo('to',to);
    return query.find();
}
// è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š
let seat = '5901d4590ce463006153ba5f';
// SDK é’ˆå¯¹ UTC æ—¶é—´åšäº†æ—¶åŒºè½¬åŒ–ï¼Œå› æ­¤æŸ¥è¯¢çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ä¼ å…¥ UTC æ—¶é—´
let from = new Date("2017-04-25T02:00:00Z");
let to = new Date("2017-04-25T14:00:00Z");
queryBooking(seat, from, to).then(result => {
    console.log(result);
}).catch(error => {
    console.error(error);
});;
```





